---
sectionclass: h2
sectionid: acr
parent-id: upandrunning
title: Create an Azure Container Registry 
---

Now we will discover an Azure Container Registry (that was automatically created and attached to our AKS cluster for this condensed workshop), and build and push an application image to it.

### Tasks

#### Discover the Azure Container Registry (ACR)

{% collapsible %}
```sh
registry=$(az acr list --query "[].{Name:name}" --output tsv); echo $registry
```
{% endcollapsible %}

#### Use Azure Container Registry Build to push the container images to your new registry

**Task Hints**
* ACR includes a feature called 'ACR Tasks' which can build container images remotely in Azure, and store the resulting image in the registry. [This guide in the ACR documentation covers how to run a quick build task](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-tutorial-quick-task#build-in-azure-with-acr-tasks)
* The source code of the captureorder project is on GitHub here, `https://github.com/Azure/azch-captureorder.git` and can be checked out to your cloud shell session with `git`. It includes the `Dockerfile` to build the image.
* There is no need to run `az acr login` when working the the Cloud Shell.
* When running `az acr build` be careful with the last parameter which is the Docker build context directory, it's usual to `cd` into the directory where the `Dockerfile` is situated, and pass `.` (a single dot) as the build context
* You can tag and name the image however you wish, e.g. `captureorder:v1` or you might want to [use a variable](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-tasks-reference-yaml#run-variables) to dynamically tag the image
  
{% collapsible %}

> **Note** The Azure Cloud Shell is already authenticated against Azure Container Registry. You don't need to do `az acr login` which also won't work on the Cloud Shell because this requires the Docker daemon to be running.

Clone the application code on Azure Cloud Shell:

```sh
git clone https://github.com/Azure/azch-captureorder.git
cd azch-captureorder
```

Use Azure Container Registry Build to build and push the container images:

```sh
az acr build -t "captureorder:{% raw %}{{.Run.ID}}{% endraw %}" -r $registry .
```

> **Note** On completion you'll get a build ID in a message similar to ``Run ID: cb1 was successful after 3m14s``. Use that Run ID (`cb1` in this example) as the image tag in the next step.

{% endcollapsible %}

##### Modify the captureorder deployment specification to pull its image from the ACR registry

Normally, you would need to first authorize the AKS cluster to connect to the Authorize the AKS cluster to theAzure Container Registry. This would be done using the `az aks update` command with the `--attach-acr` argument as documented [here.](https://docs.microsoft.com/en-us/azure/aks/cluster-container-registry-integration#configure-acr-integration-for-existing-aks-clusters) However, this has been done automatically for this condensed workshop.

{% collapsible %}
Edit the deployment specification for the captureorder pod with this command:

```sh
kubectl edit deploy captureorder
```

Find an replace this container image property line:

```sh
image: azch/captureorder
```

With this (substituting the your ACR unique name and the build tag from the previous step):

```sh
image: <acr_name>.azurecr.io/captureorder:<build_tag>
```

> **Note** In vi, you can search with this command `/image:`, and enter insert mode with this key `i`, and exit insert mode with `ESC`, and save your changes and exit the editor with `:wq`.

Use this command to watch kubernetes redeploy the captureorder pods using the image from the ACR registry:

```sh
kubectl get po -w
```

If it happens too quickly to see with the above command, you can describe one of the pods with this command to see that it's using the ACR image:

```sh
kubectl describe po <pod_name>
```
{% endcollapsible %}

> **Resources**
> * <https://docs.microsoft.com/en-us/azure/container-registry>
> * <https://docs.microsoft.com/en-us/azure/container-registry/container-registry-auth-aks>
> * <https://docs.microsoft.com/en-us/azure/aks/cluster-container-registry-integration>
> * <https://docs.microsoft.com/en-us/cli/azure/acr?view=azure-cli-latest#az-acr-build>
